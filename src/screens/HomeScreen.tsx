// src/screens/HomeScreen.tsx
import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  SafeAreaView,
  StatusBar,
  ScrollView,
  TextInput,
  ActivityIndicator,
  Alert,
  Keyboard,
  Share,
  Dimensions,
} from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useFocusEffect } from '@react-navigation/native';

const USER_NAME_KEY = '@UserNameKey';
const USER_HIGH_SCORE_KEY = '@UserHighScoreKey';
const USER_LAST_SCORE_KEY = '@UserLastScoreKey';
const BOOKMARKED_QUESTIONS_KEY = '@BookmarkedQuestionsKey';

const { width } = Dimensions.get('window');
const cardMargin = 15;
const cardPadding = 15;

const numColumns = 2;
const cardWidth = (width - cardMargin * (numColumns + 1)) / numColumns;

type RootStackParamList = {
  Home: undefined;
  Quiz: undefined;
  OneLiner: undefined;
  BookmarkedScreen: undefined;
};

const HomeScreen = ({ navigation }) => {
  const [userName, setUserName] = useState<string | null>(null);
  const [nameInput, setNameInput] = useState<string>('');
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [isEditingName, setIsEditingName] = useState<boolean>(false);

  const [highScore, setHighScore] = useState<string | null>(null);
  const [lastScore, setLastScore] = useState<string | null>(null);
  const [bookmarkedCount, setBookmarkedCount] = useState<number>(0);

  const loadUserData = useCallback(async () => {
    setIsLoading(true);
    try {
      const storedName = await AsyncStorage.getItem(USER_NAME_KEY);
      const storedHighScore = await AsyncStorage.getItem(USER_HIGH_SCORE_KEY);
      const storedLastScore = await AsyncStorage.getItem(USER_LAST_SCORE_KEY);
      const storedBookmarks = await AsyncStorage.getItem(BOOKMARKED_QUESTIONS_KEY);

      setUserName(storedName);
      setHighScore(storedHighScore);
      setLastScore(storedLastScore);

      if (storedBookmarks) {
        const bookmarksArray = JSON.parse(storedBookmarks);
        setBookmarkedCount(bookmarksArray.length);
      } else {
        setBookmarkedCount(0);
      }

      if (storedName === null && !isEditingName && !userName) {
        setIsEditingName(true);
      }
    } catch (e) {
      console.error("Failed to load user data.", e);
      setUserName(null);
      setHighScore(null);
      setLastScore(null);
      setBookmarkedCount(0);
      if (!isEditingName && !userName) {
         setIsEditingName(true);
      }
    } finally {
      setIsLoading(false);
    }
  }, [isEditingName, userName]);

  useFocusEffect(loadUserData);

  useEffect(() => {
    // рдпрд╣ useEffect рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдпрджрд┐ loadUserData рдХреЗ рдмрд╛рдж рднреА userName null рд╣реИ
    // рдФрд░ isEditingName false рд╣реИ, рддреЛ рдирд╛рдо рдЗрдирдкреБрдЯ рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛рдПред
    // рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдРрдк рд▓реЛрдб рдХреЗ рд▓рд┐рдП рд╣реИред
    const checkAndSetInitialEditingName = async () => {
      if (!isLoading && userName === null && !isEditingName) {
          setIsEditingName(true);
      }
    };
    checkAndSetInitialEditingName();
  }, [isLoading, userName, isEditingName]);


  const saveName = async () => {
    if (!nameInput.trim() && userName) {
      setIsEditingName(false);
      setNameInput(userName);
      Keyboard.dismiss();
      return;
    }
    if (!nameInput.trim() && !userName) {
      setIsEditingName(false);
      Keyboard.dismiss();
      return;
    }

    Keyboard.dismiss();
    try {
      const nameToSave = nameInput.trim();
      await AsyncStorage.setItem(USER_NAME_KEY, nameToSave);
      setUserName(nameToSave);
      setIsEditingName(false);
    } catch (e) {
      console.error("Failed to save user name.", e);
      Alert.alert("Error", "Could not save your name.");
    }
  };

  const handleChangeName = () => {
    setNameInput(userName || '');
    setIsEditingName(true);
  };

  const handleShareApp = async () => {
    try {
      const appLink = "https://play.google.com/store/apps/details?id=your.app.id"; // рдЕрдкрдиреА рдРрдк рдХрд╛ рд▓рд┐рдВрдХ рдбрд╛рд▓реЗрдВ
      let message = `Check out this Railway Exam Prep app!`; // рдЕрдВрдЧреНрд░реЗрдЬреА рдореЗрдВ рд╕рдВрджреЗрд╢
      if (userName) {
        message += `\nMy name is ${userName}.`;
      }
      if (highScore) {
        message += `\nMy High Score: ${highScore}`;
      }
      if (lastScore) {
        message += `\nMy Last Score: ${lastScore}`;
      }
      message += `\nGet it here: ${appLink}`;

      await Share.share({
        message: message,
        title: 'Railway Exam Prep App', // Android рдХреЗ рд▓рд┐рдП рд╡реИрдХрд▓реНрдкрд┐рдХ
      });
    } catch (error) {
      Alert.alert("Error", "Could not share the app.");
      console.error("Share error:", error.message);
    }
  };

  // рдореЗрдиреВ рдЖрдЗрдЯрдореНрд╕ (рд╢реАрд░реНрд╖рдХ рдФрд░ рд╡рд┐рд╡рд░рдг рд╣рд┐рдВрджреА рдореЗрдВ, рдЬреИрд╕рд╛ рдкрд╣рд▓реЗ рдерд╛)
  const menuItems = [
    { id: 'quiz', title: 'рдХреНрд╡рд┐рдЬрд╝ рдкреНрд░реИрдХреНрдЯрд┐рд╕', color: '#3498db', navigateTo: 'Quiz', icon: 'ЁЯОп', description: 'рд╕рдордпрдмрджреНрдз рдХреНрд╡рд┐рдЬрд╝ рдХреЗ рд╕рд╛рде рдЕрдкрдиреА рддреИрдпрд╛рд░реА рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░реЗрдВред' },
    { id: 'oneliner', title: 'рд╡рди-рд▓рд╛рдЗрдирд░ рд░рд┐рд╡рд┐рдЬрд╝рди', color: '#2ecc71', navigateTo: 'OneLiner', icon: 'ЁЯТб', description: 'рдорд╣рддреНрд╡рдкреВрд░реНрдг рддрдереНрдпреЛрдВ рдФрд░ GK рдХреЛ рддреБрд░рдВрдд рдпрд╛рдж рдХрд░реЗрдВ рдФрд░ рджреЛрд╣рд░рд╛рдПрдВред' },
    { id: 'bookmarks', title: `рдмреБрдХрдорд╛рд░реНрдХреНрд╕ (${bookmarkedCount})`, color: '#f39c12', navigateTo: 'BookmarkedScreen', icon: 'ЁЯФЦ', description: 'рдЕрдкрдиреЗ рд╕рд╣реЗрдЬреЗ рдЧрдП рдкреНрд░рд╢реНрдиреЛрдВ рдФрд░ рдиреЛрдЯреНрд╕ рддрдХ рдкрд╣реБрдВрдЪреЗрдВред' },
    { id: 'share', title: 'рдРрдк рд╢реЗрдпрд░ рдХрд░реЗрдВ', color: '#9b59b6', onPress: handleShareApp, icon: 'ЁЯУд', description: 'рдЗрд╕ рдРрдк рдХреЛ рдЕрдкрдиреЗ рджреЛрд╕реНрддреЛрдВ рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред' },
  ];

  if (isLoading) {
    return (
      <SafeAreaView style={styles.safeArea}>
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#007bff" />
          <Text style={styles.loadingText}>Loading...</Text>
        </View>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView style={styles.safeArea}>
      <StatusBar barStyle="light-content" backgroundColor="#0056b3" /> {/* рдирдпрд╛ рд╣реЗрдбрд░ рд░рдВрдЧ */}
      <ScrollView contentContainerStyle={styles.scrollViewContainer}>
        <View style={styles.header}>
          <Text style={styles.headerAppTitle}>Railway Exam Prep</Text> {/* рдРрдк рдХрд╛ рдЯрд╛рдЗрдЯрд▓ */}
          {userName && !isEditingName ? (
            <View style={styles.welcomeContainer}>
              <Text style={styles.welcomeText}>Welcome,</Text>
              <Text style={styles.userNameText}>{userName}!</Text>
              <TouchableOpacity onPress={handleChangeName}>
                <Text style={styles.changeNameLink}> (Change)</Text>
              </TouchableOpacity>
            </View>
          ) : (
             !isEditingName && <Text style={styles.headerSubtitle}>Your guide towards success</Text>
          )}
        </View>

        {isEditingName && (
          <View style={styles.nameInputSection}>
            <TextInput
              style={styles.textInput}
              placeholder={userName ? "Enter new name" : "Enter your name to personalize"}
              placeholderTextColor="#a0a0a0"
              value={nameInput}
              onChangeText={setNameInput}
              onSubmitEditing={saveName}
              autoFocus={true}
            />
            <TouchableOpacity
              style={styles.saveButtonSmall}
              onPress={saveName}
              activeOpacity={0.7}
            >
              <Text style={styles.saveButtonTextSmall}>Save</Text>
            </TouchableOpacity>
          </View>
        )}

        {(highScore || lastScore) && !isEditingName && (
          <View style={styles.statsOuterContainer}>
            <View style={styles.statsSection}>
              {highScore && <Text style={styles.statText}><Text style={styles.statLabel}>High Score:</Text> {highScore}</Text>}
              {lastScore && <Text style={styles.statText}><Text style={styles.statLabel}>Last Score:</Text> {lastScore}</Text>}
            </View>
          </View>
        )}

        <View style={styles.menuGrid}>
          {menuItems.map((item) => (
            <TouchableOpacity
              key={item.id}
              style={[styles.card, { width: cardWidth }]}
              onPress={() => {
                if (item.navigateTo) {
                  navigation.navigate(item.navigateTo as keyof RootStackParamList);
                } else if (item.onPress) {
                  item.onPress();
                }
              }}
              activeOpacity={0.8}
            >
              <View style={[styles.iconWrapper, { backgroundColor: item.color + '2A' }]}>
                <Text style={[styles.iconText, { color: item.color }]}>{item.icon}</Text>
              </View>
              <Text style={styles.cardTitle} numberOfLines={1} ellipsizeMode="tail">{item.title}</Text>
              <Text style={styles.cardDescription} numberOfLines={2} ellipsizeMode="tail">{item.description}</Text>
              <View style={[styles.goArrowContainer, {backgroundColor: item.color}]}>
                 <Text style={styles.goArrow}>тЮФ</Text>
              </View>
            </TouchableOpacity>
          ))}
        </View>
      </ScrollView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: '#f4f7f9', // рдереЛрдбрд╝рд╛ рдФрд░ рд╕рд╛рдл рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб
  },
  scrollViewContainer: {
    flexGrow: 1,
    paddingBottom: 30, // рдиреАрдЪреЗ рдФрд░ рдкреИрдбрд┐рдВрдЧ
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#f4f7f9',
  },
  loadingText: {
    marginTop: 12,
    fontSize: 17,
    color: '#007bff', // рд▓реЛрдбрд┐рдВрдЧ рдЯреЗрдХреНрд╕реНрдЯ рдХрд╛ рд░рдВрдЧ рдмрджрд▓рд╛
  },
  header: {
    backgroundColor: '#007bff', // рдирдпрд╛ рдЖрдХрд░реНрд╖рдХ рдиреАрд▓рд╛ рд░рдВрдЧ
    paddingTop: StatusBar.currentHeight ? StatusBar.currentHeight + 15 : 45, // рд╕реНрдЯреЗрдЯрд╕ рдмрд╛рд░ рдХреЗ рд▓рд┐рдП рд╕реБрд░рдХреНрд╖рд┐рдд рдХреНрд╖реЗрддреНрд░
    paddingBottom: 25,
    paddingHorizontal: 20,
    alignItems: 'center',
    borderBottomLeftRadius: 30,
    borderBottomRightRadius: 30,
    marginBottom: 15,
    elevation: 8, // рдереЛрдбрд╝рд╛ рдФрд░ рдЧрд╣рд░рд╛ рд╢реИрдбреЛ
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.2,
    shadowRadius: 5,
  },
  headerAppTitle: { // рдРрдк рдХреЗ рдЯрд╛рдЗрдЯрд▓ рдХреЗ рд▓рд┐рдП рдирдпрд╛ рд╕реНрдЯрд╛рдЗрд▓
    fontSize: 26,
    fontWeight: 'bold',
    color: '#ffffff',
    marginBottom: 15, // рд╡реЗрд▓рдХрдо рдЯреЗрдХреНрд╕реНрдЯ рд╕реЗ рдереЛрдбрд╝реА рджреВрд░реА
  },
  welcomeContainer: {
    alignItems: 'center', // рдХрдВрдЯреЗрдВрдЯ рдХреЛ рд╕реЗрдВрдЯрд░ рдХрд░реЗрдВ
  },
  welcomeText: { // "Welcome," рдХреЗ рд▓рд┐рдП рд╕реНрдЯрд╛рдЗрд▓
    fontSize: 18,
    color: '#e0e0e0', // рдереЛрдбрд╝рд╛ рд╣рд▓реНрдХрд╛ рд░рдВрдЧ
    textAlign: 'center',
  },
  userNameText: { // рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдирд╛рдо рдХреЗ рд▓рд┐рдП рд╕реНрдЯрд╛рдЗрд▓
    fontSize: 28, // рдмрдбрд╝рд╛ рдлрд╝реЙрдиреНрдЯ рд╕рд╛рдЗрдЬрд╝
    fontWeight: 'bold',
    color: '#ffffff', // рд╕рдлреЗрдж рд░рдВрдЧ рддрд╛рдХрд┐ nс╗Хi bс║нt рд╣реЛ
    textAlign: 'center',
    marginTop: 4, // "Welcome," рд╕реЗ рдереЛрдбрд╝реА рджреВрд░реА
    marginBottom: 8, // "Change" рд▓рд┐рдВрдХ рд╕реЗ рдереЛрдбрд╝реА рджреВрд░реА
  },
  headerSubtitle: { // рдЬрдм рдирд╛рдо рди рд╣реЛ
    fontSize: 17,
    color: '#bdc3c7',
    textAlign: 'center',
    marginTop: 10,
  },
  changeNameLink: {
    fontSize: 15,
    color: '#cce5ff', // рд╣реЗрдбрд░ рдХреЗ рд░рдВрдЧ рд╕реЗ рдорд┐рд▓рддрд╛-рдЬреБрд▓рддрд╛ рд╣рд▓реНрдХрд╛ рдиреАрд▓рд╛
    fontWeight: '500',
    textDecorationLine: 'underline', // рдЕрдВрдбрд░рд▓рд╛рдЗрди рддрд╛рдХрд┐ рдХреНрд▓рд┐рдХреЗрдмрд▓ рд▓рдЧреЗ
  },
  nameInputSection: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: cardMargin,
    backgroundColor: '#ffffff',
    marginHorizontal: cardMargin,
    borderRadius: 12,
    elevation: 4,
    shadowColor: '#000000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    marginBottom: 25, // рдЕрдЧрд▓реЗ рд╕реЗрдХреНрд╢рди рд╕реЗ рдереЛрдбрд╝реА рдЕрдзрд┐рдХ рджреВрд░реА
    marginTop: -30, // рд╣реЗрдбрд░ рдкрд░ рдереЛрдбрд╝рд╛ рдФрд░ рдУрд╡рд░рд▓реИрдк
    paddingVertical: 6, // рдереЛрдбрд╝реА рдХрдо рд╡рд░реНрдЯрд┐рдХрд▓ рдкреИрдбрд┐рдВрдЧ
  },
  textInput: {
    flex: 1,
    paddingHorizontal: 15,
    paddingVertical: 12,
    fontSize: 16,
    color: '#333333',
    marginRight: 10,
  },
  saveButtonSmall: {
    backgroundColor: '#28a745', // рдереЛрдбрд╝рд╛ рдФрд░ рд╡рд╛рдЗрдмреНрд░реЗрдВрдЯ рд╣рд░рд╛
    paddingVertical: 12,
    paddingHorizontal: 20,
    borderRadius: 10,
  },
  saveButtonTextSmall: {
    color: '#ffffff',
    fontSize: 15,
    fontWeight: 'bold',
  },
  statsOuterContainer: {
    marginHorizontal: cardMargin,
    marginBottom: 25,
  },
  statsSection: {
    backgroundColor: '#ffffff',
    paddingVertical: 20,
    paddingHorizontal: 20,
    borderRadius: 12,
    elevation: 4,
    shadowColor: '#000000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
  },
  statText: {
    fontSize: 17, // рдереЛрдбрд╝рд╛ рдмрдбрд╝рд╛
    color: '#34495e',
    fontWeight: '500',
    marginVertical: 6,
  },
  statLabel: {
    fontWeight: 'bold',
    color: '#2c3e50',
  },
  menuGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    paddingHorizontal: cardMargin / 2,
    // marginTop: 0, // рдпрджрд┐ рдЖрдБрдХрдбрд╝реЗ рдирд╣реАрдВ рд╣реИрдВ рддреЛ рднреА рдареАрдХ рд▓рдЧреЗрдЧрд╛
  },
  card: {
    backgroundColor: '#ffffff',
    borderRadius: 18, // рдФрд░ рдЧреЛрд▓
    padding: cardPadding,
    marginBottom: cardMargin,
    elevation: 6, // рдереЛрдбрд╝рд╛ рдФрд░ рд╢реИрдбреЛ
    shadowColor: '#000000',
    shadowOffset: { width: 0, height: 3 },
    shadowOpacity: 0.1, // рдереЛрдбрд╝реА рдХрдо рдУрдкреЗрд╕рд┐рдЯреА
    shadowRadius: 7,
    alignItems: 'center',
  },
  iconWrapper: {
    width: 64, // рдереЛрдбрд╝рд╛ рдмрдбрд╝рд╛
    height: 64,
    borderRadius: 32,
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 14,
  },
  iconText: {
    fontSize: 30, // рдереЛрдбрд╝рд╛ рдмрдбрд╝рд╛
  },
  cardTitle: {
    fontSize: 16, // рдереЛрдбрд╝рд╛ рдмрдврд╝рд╛рдпрд╛
    fontWeight: 'bold', // рд╡рд╛рдкрд╕ рдмреЛрд▓реНрдб рдХрд┐рдпрд╛
    color: '#34495e',
    marginBottom: 7,
    textAlign: 'center',
  },
  cardDescription: {
    fontSize: 13, // рдереЛрдбрд╝рд╛ рдмрдврд╝рд╛рдпрд╛
    color: '#6c757d', // рдереЛрдбрд╝рд╛ рдбрд╛рд░реНрдХ рдЧреНрд░реЗ
    lineHeight: 19,
    textAlign: 'center',
    minHeight: 38,
    marginBottom: 12,
  },
  goArrowContainer: {
    position: 'absolute',
    right: 12,
    bottom: 12,
    width: 32,
    height: 32,
    borderRadius: 16,
    justifyContent: 'center',
    alignItems: 'center',
  },
  goArrow: {
    color: '#fff',
    fontSize: 18,
    fontWeight: 'bold',
  }
});

export default HomeScreen;
